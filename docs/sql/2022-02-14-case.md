---
layout: post
title:  "CASE 문 (CASE WHEN)"
parent: SQL
nav_order: 4
date:   2022-02-14 22:39:00 +0900
---
# CASE Statement
{: .no_toc }

<details open markdown="block">
  <summary>
    목차
  </summary>
  {: .text-delta }
1. TOC
{:toc}
</details>

## CASE WHEN
---
CASE 문 구조
```sql
CASE WHEN <condition1> THEN <result1>
    WHEN <condition2> THEN <result2>
    ...
    ELSE <result_else> END AS new_column
```

```sql
-- 매치 테이블에서 홈팀 득점과 어웨이팀 득점, 그리고 두 득점에 따른 outcome을 CASE문을 활용하여 추출
SELECT id,
  home_goal,
  away_goal,
  CASE WHEN home_goal > away_goal THEN 'Home Team Win'
       WHEN home_goal < away_goal THEN 'Away Team Win'
       ELSE 'Tie' END AS outcome
FROM match
WHERE season = '2013/2014';
```

OUTPUT

|id|home_goal|away_goal|outcome|
|---|---|---|---|
|1237|2 |0 |Home Team Win| 
|1238|0 |1 |Away Team Win| 
|1239|1 |0 |Home Team Win| 
|1240|0 |0 |Tie |

## CASE WHEN with AND
---
```sql
-- 매치 테이블에서 첼시 (team_id = 8455)의 경기 일자, 홈팀 id, 어웨이팀 id, 첼시의 승 여부를 CASE문으로 추출
SELECT date, hometeam_id, awayteam_id,
  CASE WHEN hometeam_id = 8455 AND home_goal > away_goal
            THEN 'Chelsea home win!'
       WHEN awayteam_id = 8455 AND home_goal < away_goal
            THEN 'Chelsea away win!'
       ELSE 'Loss or tie :(' END AS outcome
FROM match
WHERE hometeam_id = 8455 OR awayteam_id = 8455;
```

## NULL VALUE
---
```sql
SELECT date, season,
  CASE WHEN hometeam_id = 8455 AND home_goal > away_goal
            THEN 'Chelsea home win!'
       WHEN awayteam_id = 8455 AND home_goal < away_goal
            THEN 'Chelsea away win!'
       END AS outcome
FROM match
WHERE hometeam_id = 8455 OR awayteam_id = 8455;
-- 첼시의 무승부/패배 경기인 경우에는 outcome 컬럼 값이 NULL
```

OUTPUT

| date       | season    | outcome           |
|------------|-----------|-------------------|
| 2011-08-14 | 2011/2012 | NULL              |
| 2011-12-22 | 2011/2012 | NULL              |
| 2012-12-08 | 2012/2013 | Chelsea away win! |
| 2013-03-02 | 2012/2013 | Chelsea home win! |

```sql
SELECT date, season,
  CASE WHEN hometeam_id = 8455 AND home_goal > away_goal
            THEN 'Chelsea home win!'
       WHEN awayteam_id = 8455 AND home_goal < away_goal
            THEN 'Chelsea away win!' END AS outcome
FROM match
WHERE CASE WHEN hometeam_id = 8455 AND home_goal > away_goal
                THEN 'Chelsea home win!'
           WHEN awayteam_id = 8455 AND home_goal < away_goal
                THEN 'Chelsea away win!' END 
      IS NOT NULL;
-- WHERE 문을 추가해서 NULL인 경우 (무승부/패배 경기) 제외
```

OUTPUT

| date       | season    | outcome           |
|------------|-----------|-------------------|
| 2011-11-05 | 2011/2012 | Chelsea away win! |
| 2011-11-26 | 2011/2012 | Chelsea home win! |
| 2011-12-03 | 2011/2012 | Chelsea away win! |

## CASE WHEN with Aggregate Function (집계 함수)
---
### COUNT
```sql
SELECT
    season,
    COUNT(CASE WHEN hometeam_id = 8650 AND home_goal > away_goal
          THEN 54321 END) AS home_wins,
    COUNT(CASE WHEN awayteam_id = 8650 AND away_goal > home_goal
          THEN 'Some random text' END) AS away_wins
FROM match
GROUP BY season;
-- 리버풀 (team_id = 8650)의 시즌별 홈 승리와 원정 승리 수
-- COUNT이기 때문에 THEN 다음 결과 값이 크게 중요하지 않다
```

OUTPUT

| season    | home_wins | away_wins |
|-----------|-----------|-----------|
 | 2011/2012 | 6 |8|
| 2012/2013 | 9|7|
| 2013/2014 | 16|10|
| 2014/2015 | 10|8|

### SUM
```sql
SELECT
    season,
    SUM(CASE WHEN hometeam_id = 8650
          THEN home_goal END) AS home_goals,
    SUM(CASE WHEN awayteam_id = 8650
          THEN away_goal END) AS away_goals
FROM match
GROUP BY season;
-- 리버풀의 시즌별 홈 경기 득점과 원정 경기 득점
```

OUTPUT

|season|home_goals|away_goals|
|---|---|---|
 | 2011/2012 | 24|23 |
| 2012/2013 | 33 |38 |
| 2013/2014 | 53 |48 |
| 2014/2015 | 30|22 |

### AVG
```sql
SELECT
  season,
  ROUND(AVG(CASE WHEN hometeam_id = 8455 AND home_goal > away_goal THEN 1
           WHEN hometeam_id = 8455 AND home_goal < away_goal THEN 0
           END),2) AS pct_homewins,
  ROUND(AVG(CASE WHEN awayteam_id = 8455 AND away_goal > home_goal THEN 1
           WHEN awayteam_id = 8455 AND away_goal < home_goal THEN 0
           END),2) AS pct_awaywins
FROM match
GROUP BY season;
-- 첼시의 홈 승리 확률 및 원정 승리 확률 (무승부 제외)
```

OUTPUT

| season    | pct_homewins     | pct_awaywins     |
|-----------|------------------|------------------|
 | 2011/2012 | 0.75|0.5 | 
| 2012/2013 | 0.86|0.67 | 
| 2013/2014 | 0.94|0.67 | 
| 2014/2015 | 1|0.79 |
