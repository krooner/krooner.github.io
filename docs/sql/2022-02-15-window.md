---
layout: post
title:  "윈도우 함수 (Window Functions)"
parent: SQL
nav_order: 7
date:   2022-02-15 16:52:00 +0900
---
# Window Functions
{: .no_toc }

<details open markdown="block">
  <summary>
    목차
  </summary>
  {: .text-delta }
1. TOC
{:toc}
</details>

## Aggregate value
---
집계 함수 값 (aggregate values)을 추출할 때, 모든 non-aggregate columns (country_id, season, date)에 대해 `GROUP BY`를 적용하도록 요구됨.

```sql
SELECT
  country_id,
  season,
  date,
  AVG(home_goal) AS avg_home
FROM match
GROUP BY country_id;
-- ERROR: column "match.season" must appear in the GROUP BY clause or be used in an aggregate function
```

## Window functions
---
이미 생성된 결과 (윈도우)에 대해 계산을 수행함
- Aggregate calculation은 `SELECT` 문에서의 서브쿼리와 유사하며, totals/rankings/moving averages를 계산하는데 활용됨
- `ORDER BY` 문을 제외하고 모든 쿼리가 처리된 이후에 수행되며 쿼리 결과를 활용함
- PostgreSQL, Oracle, MySQL, SQL Server 등에서는 지원하지만, SQLite에서는 지원하지 않음

### 2011/12 시즌 경기별 득점과 평균 득점 비교
```sql
SELECT
    date,
    (home_goal + away_goal) AS goals,
    AVG(home_goal + away_goal) OVER() AS overall_avg
FROM match
WHERE season = '2011/2012';
```

OUTPUT

| date       | goals | overall_avg       |
|------------|-------|-------------------|
 | 2011-07-29 | 3| 2.71646           |
| 2011-07-30 | 2| 2.71646           |
| 2011-07-30 | 4| 2.71646           |
| 2011-07-30 | 1| 2.71646           |

### 2011/12 시즌 경기별 득점 및 다득점 순위
```sql
SELECT
    date,
    (home_goal + away_goal) AS goals,
    RANK() OVER(ORDER BY home_goal + away_goal DESC) AS goals_rank
FROM match
WHERE season = '2011/2012';
```

OUTPUT

| date       | goals | goals_rank |
|------------|-------|------------|
 | 2011-11-06 | 10|1|
| 2011-08-28 | 10|1|
| 2012-05-12 | 9|3|
| 2012-02-12 | 9|3|

## Window partitions
---
### OVER and PARTITION BY
카테고리에 따른 개별 값을 계산하며, 같은 컬럼 내에서도 다른 계산을 수행한다.

`PARTITION BY`
- 1개 이상의 컬럼에 대하여 데이터를 Partition할 수 있다.
- aggregate calculation, ranks에 대해서도 수행할 수 있다.

### 경기별 득점 수 및 전체 평균 득점 수와 비교
```sql
SELECT
    date,
    (home_goal + away_goal) AS goals,
    AVG(home_goal + away_goal) OVER() AS overall_avg
FROM match;
```

OUTPUT

| date       | goals | overall_avg |
|------------|-------|-------------|
 | 2011-12-17 | 3| 2.73210     |
| 2012-05-01 | 2| 2.73210     |
| 2012-11-27 | 4| 2.73210     |
| 2013-04-20 | 1| 2.73210     |
| 2013-11-09 | 5| 2.73210     |

### 경기별 득점 수 및 해당 시즌 평균 득점 수와 비교
```sql
SELECT
    date,
    (home_goal + away_goal) AS goals,
    AVG(home_goal + away_goal) OVER(PARTITION BY season) AS season_avg
FROM match;
```

OUTPUT

| date       | goals | season_avg  |
|------------|-------|-------------|
| 2011-12-17 | 3| 2.71646     |
| 2012-05-01 | 2| 2.71646     |
| 2012-11-27 | 4| 2.77270     |
| 2013-04-20 | 1| 2.77270     |
| 2013-11-09 | 5| 2.76682     |

### 경기별 득점 수 및 해당 국가 리그-시즌 평균 득점 수와 비교

```sql
SELECT
  c.name,
  m.season,
  (home_goal + away_goal) AS goals,
  AVG(home_goal + away_goal)
      OVER(PARTITION BY m.season, c.name) AS season_ctry_avg
FROM country AS c
LEFT JOIN match AS m
ON c.id = m.country_id
```

OUTPUT

| name        | season    | goals     | season_ctry_avg |
|-------------|-----------|-----------|-----------------|
| Belgium     | 2011/2012 | 1| 2.88            |
| Netherlands | 2014/2015 | 1| 3.08            |
| Belgium     | 2011/2012 | 1| 2.88            |
| Spain       | 2014/2015 | 2| 2.66            |

## Sliding windows
---
현재 행 (Current row)에 상대적인 calculation을 수행한다.
- running totals, sums, averages 등을 계산하는데 활용
- 1개 이상의 컬럼에 대한 partition 수행 가능

```sql
ROWS BETWEEN <start> AND <finish>
-- Options:
    -- PRECEDING
    -- FOLLOWING
    -- UNBOUNDED PRECEDING
    -- UNBOUNDED FOLLOWING
    -- CURRENT ROW
```

### MC 홈 경기에서 득점, 상대팀 득점, 득점 누계
```sql
-- Manchester City Home Games
SELECT
  date,
  home_goal,
  away_goal,
  SUM(home_goal)
     OVER(ORDER BY date ROWS BETWEEN
          UNBOUNDED PRECEDING AND CURRENT ROW) AS running_total
FROM match
WHERE hometeam_id = 8456 AND season = '2011/2012';
```

OUTPUT

| date       | home_goal | away_goal | running_total |
|------------|-----------|-----------|---------------|
| 2011-08-15 | 4|0 |4| 
| 2011-09-10 | 3|0 |7|
| 2011-09-24 | 2|0 |9|
| 2011-10-15 | 4|1 |13 |

### MC 홈 경기에서 득점, 상대팀 득점, 직전 홈 경기 득점 합산
```sql
-- Manchester City Home Games
SELECT date,
       home_goal,
       away_goal,
       SUM(home_goal)
          OVER(ORDER BY date
          ROWS BETWEEN 1 PRECEDING
          AND CURRENT ROW) AS last2
FROM match
WHERE hometeam_id = 8456
      AND season = '2011/2012';
```
  
OUTPUT

|date|home_goal|away_goal|last2|
|---|---|---|---|
|2011-08-15|4|0|4|
|2011-09-10|3|0|7|
|2011-09-24|2|0|5|
|2011-10-15|4|1|6|
